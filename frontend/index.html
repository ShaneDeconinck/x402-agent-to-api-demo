<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Real Estate API - x402 Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-dot { animation: pulse-dot 2s infinite; }
        .step-active { transform: scale(1.02); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .subtitle-text { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-900 h-screen p-3 pb-16 overflow-hidden">
    <!-- Intro Modal -->
    <div id="intro-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
        <div class="modal-content bg-gray-800 border border-gray-600 rounded-xl p-6 max-w-lg mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-4">x402 Protocol Demo</h2>
            <p class="text-gray-300 mb-4">
                This demo shows an <span class="text-purple-400 font-semibold">AI agent</span> autonomously paying for API access using the <span class="text-indigo-400 font-semibold">HTTP 402</span> protocol and <span class="text-green-400 font-semibold">USDC stablecoins</span>.
            </p>
            <div class="bg-gray-900 rounded-lg p-4 mb-4 text-sm">
                <div class="text-gray-400 mb-2">When you click "Run Demo":</div>
                <ol class="text-gray-300 space-y-2">
                    <li class="flex gap-2">
                        <span class="text-indigo-400">1.</span>
                        <span>Agent requests real estate listings ‚Üí gets <span class="text-yellow-400">402 Payment Required</span></span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-indigo-400">2.</span>
                        <span>Agent reads payment instructions, sends <span class="text-green-400">$0.01 USDC</span> on-chain</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-indigo-400">3.</span>
                        <span>Agent retries with payment proof ‚Üí receives data</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-indigo-400">4.</span>
                        <span>Agent analyzes listings, pays <span class="text-green-400">$0.10</span> for AI valuation</span>
                    </li>
                </ol>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500 mb-4">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span>Real USDC payments on Base Sepolia testnet</span>
            </div>
            <button onclick="closeModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                Got it, let's go!
            </button>
        </div>
    </div>

    <!-- Subtitle Bar -->
    <div id="subtitle-bar" class="fixed bottom-0 left-0 right-0 bg-black/90 border-t border-gray-700 py-4 px-6 z-40 hidden">
        <div class="max-w-4xl mx-auto text-center">
            <p id="subtitle-text" class="text-white text-xl font-medium"></p>
        </div>
    </div>

    <div class="h-full flex flex-col max-w-[1800px] mx-auto">
        <!-- Header -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 mb-3 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-white">SF Real Estate API</h1>
                <span class="text-gray-500 text-sm">x402 Protocol Demo</span>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></div>
                    <span class="text-green-400 text-xs font-mono">LIVE</span>
                </div>
                <span class="text-gray-400 text-sm">by <a href="https://shanedeconinck.be" target="_blank" class="text-white hover:text-indigo-400 font-medium">Shane Deconinck</a></span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="showModal()" class="text-gray-500 hover:text-gray-300 text-xs border border-gray-600 rounded-full w-5 h-5 flex items-center justify-center" title="How it works">?</button>
                <span class="text-gray-700">|</span>
                <label class="text-gray-400 text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Area
                </label>
                <select id="neighborhood-input" class="px-3 py-1.5 bg-gray-900 border border-gray-600 rounded text-white text-sm font-mono">
                    <option value="Mission">Mission</option>
                    <option value="SOMA">SOMA</option>
                    <option value="Marina">Marina</option>
                    <option value="Castro">Castro</option>
                    <option value="Hayes Valley">Hayes Valley</option>
                    <option value="Noe Valley">Noe Valley</option>
                    <option value="Pacific Heights">Pacific Heights</option>
                    <option value="Sunset">Sunset</option>
                    <option value="Richmond">Richmond</option>
                </select>
                <button onclick="toggleAudio()" id="audio-btn" class="p-1.5 rounded border border-gray-600 hover:border-gray-500" title="Toggle narration">
                    <svg id="audio-on" class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                    <svg id="audio-off" class="w-5 h-5 text-gray-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>
                </button>
                                <button onclick="runDemo()" id="run-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 text-white font-bold py-1.5 px-6 rounded text-sm flex items-center gap-2">
                    <span id="btn-text">Run Demo</span>
                    <span id="btn-spinner" class="hidden">
                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 grid grid-cols-12 gap-3 min-h-0">
            <!-- Left: Agent + Wallet -->
            <div class="col-span-3 flex flex-col gap-3">
                <!-- Agent Panel -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3 flex-1">
                    <h2 class="text-sm font-bold text-white mb-2 flex items-center gap-2">
                        <span class="text-lg">ü§ñ</span> Agent
                    </h2>
                    <div id="agent-thoughts" class="text-xs text-gray-400 space-y-2">
                        <div class="text-gray-600 italic">Waiting for task...</div>
                    </div>
                </div>

                <!-- Wallet -->
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg p-3">
                    <div class="text-xs text-white/70">Agent Wallet</div>
                    <div class="text-xl font-bold text-white font-mono" id="balance-display">Loading...</div>
                    <div class="text-xs text-white/50 font-mono truncate" id="wallet-address">...</div>
                </div>

                <!-- Transactions -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <h2 class="text-sm font-bold text-white mb-2">Transactions</h2>
                    <div id="tx-list" class="space-y-2 text-xs">
                        <div class="text-gray-600">No transactions yet</div>
                    </div>
                </div>
            </div>

            <!-- Center: Console -->
            <div class="col-span-5 bg-gray-800 border border-gray-700 rounded-lg p-3 flex flex-col min-h-0">
                <h2 class="text-sm font-bold text-white mb-2">Protocol Log</h2>
                <div id="console" class="flex-1 bg-black rounded p-3 font-mono text-xs overflow-y-auto text-gray-300 min-h-0">
                    <div class="text-gray-500">// Click "Run Demo" to start</div>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="col-span-4 flex flex-col gap-3">
                <!-- Listings -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3 flex-1">
                    <h2 class="text-sm font-bold text-white mb-2">Tier 1: Listings ($0.01)</h2>
                    <div id="listings-grid" class="space-y-2 overflow-y-auto max-h-48">
                        <div class="text-gray-600 text-xs">No listings yet</div>
                    </div>
                </div>

                <!-- Valuation -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <h2 class="text-sm font-bold text-white mb-2">Tier 2: Valuation ($0.10)</h2>
                    <div id="valuation-box" class="text-xs">
                        <div class="text-gray-600">No valuation yet</div>
                    </div>
                </div>

                <!-- Summary -->
                <div id="summary-box" class="hidden bg-green-900/30 border border-green-700 rounded-lg p-3">
                    <h2 class="text-sm font-bold text-green-400 mb-2">Summary</h2>
                    <div id="summary-content" class="text-xs text-green-300"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8888';
        let txCount = 0;
        let audioEnabled = true;
        let synth = window.speechSynthesis;

        // Narration scripts - explainer voiceover style for LinkedIn
        const NARRATIONS = {
            'init': (data) => `This is a live demo. A real AI agent, a real crypto wallet, calling a real API. Every payment is an actual blockchain transaction.`,
            'agent_thinking': (data) => `The agent needs San Francisco real estate data. It calls the API.`,
            'request_tier1': (data) => ``,
            '402_tier1': (data) => `Instead of data, it gets HTTP 402 - Payment Required. This is x402. The response contains machine-readable payment instructions. Amount, recipient, blockchain network - everything the agent needs to pay.`,
            'agent_deciding': (data) => `The agent parses these instructions. The price is acceptable. It decides to pay.`,
            'paying': () => `Now watch - it creates a real USDC payment on Base.`,
            'tx_sent': (data) => ``,
            'tx_confirmed': (data) => `Payment confirmed. The agent has cryptographic proof of payment.`,
            'waiting': () => ``,
            'retry': () => `It retries with the transaction hash as proof.`,
            'verifying': () => `The server verifies payment on-chain.`,
            'listings_success': (data) => `Access granted. The agent gets its data.`,
            'agent_analyzing': (data) => `Now it wants premium valuation data - a more expensive tier.`,
            'request_tier2': () => ``,
            '402_tier2': (data) => `Same flow. Higher price. The agent decides it's worth it.`,
            'valuation_success': (data) => `Both data tiers acquired, fully autonomously.`,
            'agent_summary': (data) => ``,
            'done': (data) => `That's x402. AI agents paying for APIs with stablecoins. No API keys. No human approval. Just code paying code.`,
        };

        let isSpeaking = false;
        let onSpeechDone = null;

        function speak(text) {
            return new Promise((resolve) => {
                if (!audioEnabled || !text) {
                    resolve();
                    return;
                }

                isSpeaking = true;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.92;
                utterance.pitch = 0.95;

                // Find warm, natural voices (premium/enhanced voices first)
                const voices = synth.getVoices();
                const preferredVoice =
                    voices.find(v => v.name.includes('Ava') && v.lang.startsWith('en')) ||      // Premium warm female
                    voices.find(v => v.name.includes('Zoe') && v.lang.startsWith('en')) ||      // Premium
                    voices.find(v => v.name.includes('Evan') && v.lang.startsWith('en')) ||     // Premium male
                    voices.find(v => v.name.includes('Tom') && v.lang.startsWith('en')) ||      // Premium warm male
                    voices.find(v => v.name.includes('Allison') && v.lang.startsWith('en')) ||  // Warm
                    voices.find(v => v.name.includes('Google UK English Female')) ||
                    voices.find(v => v.name.includes('Google US English')) ||
                    voices.find(v => v.name.includes('Karen')) ||                               // Australian, warm
                    voices.find(v => v.name.includes('Moira')) ||                               // Irish, warm
                    voices.find(v => v.name.includes('Fiona')) ||                               // Scottish
                    voices.find(v => v.name.includes('Tessa')) ||                               // South African
                    voices.find(v => v.name.includes('Daniel')) ||                              // UK male
                    voices.find(v => v.lang.startsWith('en-GB')) ||
                    voices.find(v => v.lang.startsWith('en'));

                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    console.log('Using voice:', preferredVoice.name);
                }

                utterance.onend = () => {
                    isSpeaking = false;
                    resolve();
                };
                utterance.onerror = () => {
                    isSpeaking = false;
                    resolve();
                };

                synth.speak(utterance);
            });
        }

        // Event queue for syncing with speech
        let eventQueue = [];
        let processingEvents = false;

        async function queueEvent(handler) {
            eventQueue.push(handler);
            if (!processingEvents) {
                processEventQueue();
            }
        }

        async function processEventQueue() {
            if (processingEvents || eventQueue.length === 0) return;
            processingEvents = true;

            while (eventQueue.length > 0) {
                const handler = eventQueue.shift();
                await handler();
            }

            processingEvents = false;
        }

        function showSubtitle(text) {
            const bar = document.getElementById('subtitle-bar');
            const textEl = document.getElementById('subtitle-text');
            if (text) {
                // Trigger re-animation by removing and re-adding class
                textEl.classList.remove('subtitle-text');
                void textEl.offsetWidth; // Force reflow
                textEl.classList.add('subtitle-text');
                textEl.textContent = text;
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        }

        async function narrate(key, data = {}) {
            const getText = NARRATIONS[key];
            if (getText) {
                const text = getText(data);
                showSubtitle(text);
                await speak(text);
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            document.getElementById('audio-on').classList.toggle('hidden', !audioEnabled);
            document.getElementById('audio-off').classList.toggle('hidden', audioEnabled);
            if (!audioEnabled) {
                speechQueue = [];
                isSpeaking = false;
                synth.cancel();
                showSubtitle('');
            }
        }

        function clearNarration() {
            eventQueue = [];
            processingEvents = false;
            isSpeaking = false;
            synth.cancel();
            showSubtitle('');
        }

        function closeModal() {
            document.getElementById('intro-modal').classList.add('hidden');
        }

        function showModal() {
            document.getElementById('intro-modal').classList.remove('hidden');
        }

        // Load voices and log available ones
        speechSynthesis.onvoiceschanged = () => {
            const voices = synth.getVoices();
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));
            console.log('Available English voices:', englishVoices.map(v => `${v.name} (${v.lang})`));
        };

        function log(message, type = 'info') {
            const consoleEl = document.getElementById('console');
            const colors = {
                info: 'text-gray-300',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                payment: 'text-orange-400',
                tx: 'text-blue-400',
                agent: 'text-purple-400'
            };
            consoleEl.innerHTML += `<div class="${colors[type] || colors.info}">${message}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function addAgentThought(message) {
            const el = document.getElementById('agent-thoughts');
            el.innerHTML += `<div class="bg-gray-700/50 rounded p-2">${message}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function toggleListing(index) {
            const detail = document.getElementById('listing-detail-' + index);
            const icon = document.getElementById('expand-icon-' + index);
            if (!detail || !icon) {
                console.error('Could not find listing elements for index:', index);
                return;
            }
            if (detail.classList.contains('hidden')) {
                detail.classList.remove('hidden');
                icon.textContent = '‚ñ≤';
            } else {
                detail.classList.add('hidden');
                icon.textContent = '‚ñº';
            }
        }

        function addTransaction(hash, amount, status = 'pending') {
            txCount++;
            const el = document.getElementById('tx-list');
            if (txCount === 1) el.innerHTML = '';

            const statusColor = status === 'confirmed' ? 'text-green-400' : 'text-yellow-400';
            el.innerHTML += `
                <div class="bg-gray-900 rounded p-2" id="tx-${txCount}">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Tx #${txCount}</span>
                        <span class="${statusColor}" id="tx-${txCount}-status">${status}</span>
                    </div>
                    <div class="text-white font-mono truncate">${hash.slice(0,16)}...</div>
                    <div class="text-green-400">$${amount.toFixed(2)} USDC</div>
                    <a href="https://sepolia.basescan.org/tx/${hash}" target="_blank" class="text-blue-400 hover:underline">BaseScan ‚Üí</a>
                </div>
            `;
        }

        function updateTxStatus(num, status) {
            const el = document.getElementById(`tx-${num}-status`);
            if (el) {
                el.textContent = status;
                el.className = status === 'confirmed' ? 'text-green-400' : 'text-yellow-400';
            }
        }

        async function loadBalance() {
            try {
                const res = await fetch(`${API_URL}/demo/balance`);
                const data = await res.json();
                document.getElementById('balance-display').textContent = `${data.balance_usdc.toFixed(4)} USDC`;
                document.getElementById('wallet-address').textContent = data.wallet;
            } catch (e) {
                document.getElementById('balance-display').textContent = 'Error';
            }
        }

        async function runDemo() {
            const neighborhood = document.getElementById('neighborhood-input').value || 'Mission';
            const runBtn = document.getElementById('run-btn');
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');

            // Reset UI
            runBtn.disabled = true;
            btnText.textContent = 'Running...';
            btnSpinner.classList.remove('hidden');
            document.getElementById('console').innerHTML = '';
            document.getElementById('agent-thoughts').innerHTML = '';
            document.getElementById('tx-list').innerHTML = '<div class="text-gray-600">No transactions yet</div>';
            document.getElementById('listings-grid').innerHTML = '<div class="text-gray-600 text-xs">Loading...</div>';
            document.getElementById('valuation-box').innerHTML = '<div class="text-gray-600">Waiting...</div>';
            document.getElementById('summary-box').classList.add('hidden');
            txCount = 0;

            log(`Demo: ${neighborhood} neighborhood`, 'info');
            log('', 'info');

            let demoComplete = false;
            let receivedEvents = false;

            try {
                const eventSource = new EventSource(`${API_URL}/demo/run?neighborhood=${encodeURIComponent(neighborhood)}`);

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    receivedEvents = true;

                    // Mark complete when we receive done (before queuing)
                    if (data.step === 'done' || data.step === 'error') {
                        demoComplete = true;
                    }

                    // Queue all events to sync with speech
                    queueEvent(async () => {
                        // Agent messages
                        if (data.step === 'agent') {
                            addAgentThought(data.message);
                            log(`ü§ñ ${data.message}`, 'agent');
                            if (data.action === 'thinking') await narrate('agent_thinking', data);
                            else if (data.action === 'deciding') await narrate('agent_deciding', data);
                            else if (data.action === 'analyzing') await narrate('agent_analyzing', data);
                            else if (data.action === 'summary') await narrate('agent_summary', data);
                        }
                        // Init
                        else if (data.step === 'init') {
                            document.getElementById('balance-display').textContent = `${data.balance.toFixed(4)} USDC`;
                            log(`Wallet: ${data.wallet.slice(0,10)}... | Balance: $${data.balance.toFixed(4)}`, 'info');
                            log('', 'info');
                            await narrate('init', data);
                        }
                        // Tier 1 flow
                        else if (data.step === 1) {
                            log(`[Tier 1] ${data.message}`, 'tx');
                            await narrate('request_tier1', data);
                        }
                        else if (data.step === 2) {
                            log(`‚Üê 402 Payment Required`, 'warning');
                            if (data.x402) {
                                log(`<pre class="text-yellow-400/80 text-[10px] ml-2">${JSON.stringify(data.x402, null, 2)}</pre>`, 'warning');
                            }
                            await narrate('402_tier1', data);
                        }
                        else if (data.step === 3 || data.step === 8) {
                            if (data.action === 'paying') {
                                log(`Creating payment...`, 'payment');
                                await narrate('paying', data);
                            }
                            else if (data.action === 'tx_sent') {
                                log(`Tx: ${data.tx_hash.slice(0,20)}...`, 'tx');
                                addTransaction(data.tx_hash, data.amount || 0.01);
                                await narrate('tx_sent', data);
                            }
                            else if (data.action === 'tx_confirmed') {
                                log(`‚úì Confirmed block ${data.block}`, 'success');
                                updateTxStatus(txCount, 'confirmed');
                                await narrate('tx_confirmed', data);
                            }
                            else if (data.action === 'waiting') {
                                log(`Waiting for indexing...`, 'info');
                                await narrate('waiting', data);
                            }
                        }
                        else if (data.step === 4) {
                            log(`Retry with X-Payment-Proof`, 'tx');
                            await narrate('retry', data);
                        }
                        else if (data.step === 5) {
                            if (data.action === 'verifying') {
                                log(`Server verifying...`, 'info');
                                await narrate('verifying', data);
                            }
                            else if (data.action === 'success') {
                                log(`‚úì 200 OK - ${data.listings.length} listings`, 'success');
                                await narrate('listings_success', data);

                                const grid = document.getElementById('listings-grid');
                                grid.innerHTML = data.listings.slice(0, 5).map((l, i) =>
                                    '<div class="bg-gray-900 rounded p-2 cursor-pointer hover:bg-gray-800 transition-colors" onclick="toggleListing(' + i + ')">' +
                                        '<div class="flex justify-between items-center">' +
                                            '<div>' +
                                                '<div class="text-white text-sm">' + l.address + '</div>' +
                                                '<div class="text-gray-500">' + l.bedrooms + 'bd ' + l.sqft + 'ft¬≤</div>' +
                                            '</div>' +
                                            '<div class="flex items-center gap-2">' +
                                                '<div class="text-green-400 font-bold">$' + l.price.toLocaleString() + '</div>' +
                                                '<span class="text-gray-500 text-xs" id="expand-icon-' + i + '">‚ñº</span>' +
                                            '</div>' +
                                        '</div>' +
                                        '<div id="listing-detail-' + i + '" class="hidden mt-2 pt-2 border-t border-gray-700 text-xs">' +
                                            '<div class="grid grid-cols-2 gap-1">' +
                                                '<div><span class="text-gray-500">Type:</span> <span class="text-white">' + l.property_type + '</span></div>' +
                                                '<div><span class="text-gray-500">Neighborhood:</span> <span class="text-white">' + l.neighborhood + '</span></div>' +
                                                '<div><span class="text-gray-500">Size:</span> <span class="text-white">' + l.sqft + ' ft¬≤ (' + l.sqm + ' m¬≤)</span></div>' +
                                                '<div><span class="text-gray-500">Listed:</span> <span class="text-white">' + l.days_on_market + ' days ago</span></div>' +
                                            '</div>' +
                                            '<div class="mt-1 text-gray-400 italic">' + l.description + '</div>' +
                                        '</div>' +
                                    '</div>'
                                ).join('');
                            }
                        }
                        // Tier 2 flow
                        else if (data.step === 6) {
                            log('', 'info');
                            log(`[Tier 2] ${data.message}`, 'tx');
                            await narrate('request_tier2', data);
                        }
                        else if (data.step === 7) {
                            log(`‚Üê 402 Payment Required (Tier 2)`, 'warning');
                            if (data.x402) {
                                log(`<pre class="text-yellow-400/80 text-[10px] ml-2">${JSON.stringify(data.x402, null, 2)}</pre>`, 'warning');
                            }
                            await narrate('402_tier2', data);
                        }
                        else if (data.step === 9) {
                            if (data.action === 'success') {
                                log(`‚úì 200 OK - Valuation received`, 'success');
                                await narrate('valuation_success', data);

                                const v = data.valuation;
                                document.getElementById('valuation-box').innerHTML = `
                                    <div class="bg-gray-900 rounded p-3">
                                        <div class="text-white font-semibold mb-2">${v.address}</div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <div class="text-gray-500">Estimated Value</div>
                                                <div class="text-green-400 font-bold text-lg">$${v.estimated_value.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <div class="text-gray-500">Confidence</div>
                                                <div class="text-white">${(v.confidence * 100).toFixed(0)}%</div>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-yellow-400">${v.assessment}</div>
                                    </div>
                                `;
                            }
                        }
                        // Done
                        else if (data.step === 'done') {
                            log('', 'info');
                            log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'success');
                            log(`Total spent: $${data.total_spent.toFixed(2)} USDC`, 'success');
                            log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'success');

                            document.getElementById('balance-display').textContent = `${data.new_balance.toFixed(4)} USDC`;

                            document.getElementById('summary-box').classList.remove('hidden');
                            document.getElementById('summary-content').innerHTML = `
                                <div>Total spent: <span class="font-bold">$${data.total_spent.toFixed(2)}</span></div>
                                <div>Transactions: <span class="font-bold">${txCount}</span></div>
                                <div class="mt-2"><a href="${data.basescan_url}" target="_blank" class="text-blue-400 hover:underline">View on BaseScan ‚Üí</a></div>
                            `;

                            await narrate('done', data);
                            // Hide subtitle after a delay
                            setTimeout(() => showSubtitle(''), 3000);

                            eventSource.close();
                            runBtn.disabled = false;
                            btnText.textContent = 'Run Demo';
                            btnSpinner.classList.add('hidden');
                        }
                        else if (data.step === 'error') {
                            log(`Error: ${data.message}`, 'error');
                            clearNarration();
                            eventSource.close();
                            runBtn.disabled = false;
                            btnText.textContent = 'Run Demo';
                            btnSpinner.classList.add('hidden');
                        }
                    }); // end queueEvent
                };

                eventSource.onerror = function() {
                    eventSource.close();
                    // Ignore connection close if we received events (stream just ended)
                    if (demoComplete || receivedEvents) {
                        return;
                    }
                    // Only show error if we never got any events
                    log('Connection error', 'error');
                    clearNarration();
                    runBtn.disabled = false;
                    btnText.textContent = 'Run Demo';
                    btnSpinner.classList.add('hidden');
                };
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                runBtn.disabled = false;
                btnText.textContent = 'Run Demo';
                btnSpinner.classList.add('hidden');
            }
        }

        loadBalance();
    </script>
</body>
</html>
